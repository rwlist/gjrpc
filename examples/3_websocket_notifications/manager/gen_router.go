// Code generated by gjrpc. DO NOT EDIT.

package manager

import (
	"encoding/json"
	jsonrpc "github.com/rwlist/gjrpc/pkg/jsonrpc"
	"strings"
	proto "wsexample/proto"
)

type Router struct {
	handlers     *Handlers
	convertError jsonrpc.ErrorConverter
}

func NewRouter(handlers *Handlers, convertError jsonrpc.ErrorConverter) *Router {
	if convertError == nil {
		convertError = jsonrpc.DefaultErrorConverter
	}
	return &Router{
		convertError: convertError,
		handlers:     handlers,
	}
}

func (r *Router) notFound() (jsonrpc.Result, *jsonrpc.Error) {
	return nil, &jsonrpc.MethodNotFound
}

func (r *Router) Handle(req *jsonrpc.Request) *jsonrpc.Response {
	path := strings.Split(req.Method, ".")

	println("manager router: ", req.Method, path)

	res, e := r.handle(path, req)
	var result json.RawMessage
	if e == nil {
		var err error
		result, err = json.Marshal(res)
		if err != nil {
			_, e = r.convertError(err)
		}
	}
	return jsonrpc.NewResponse(req, result, e)
}

func (r *Router) handle(path []string, req *jsonrpc.Request) (jsonrpc.Result, *jsonrpc.Error) {
	if len(path) == 0 {
		return r.notFound()
	}
	switch path[0] {
	case "manager":
		return r.handleManager(path[1:], req)
	}
	return r.notFound()
}

func (r *Router) handleManager(path []string, req *jsonrpc.Request) (jsonrpc.Result, *jsonrpc.Error) {
	if len(path) == 0 {
		return r.notFound()
	}
	switch path[0] {
	case "connect":
		return r.handleManagerConnect(path[1:], req)
	}
	return r.notFound()
}

func (r *Router) handleManagerConnect(path []string, req *jsonrpc.Request) (jsonrpc.Result, *jsonrpc.Error) {
	if len(path) == 0 {
		var request proto.ConnectRequest
		if err := json.Unmarshal(req.Params, &request); err != nil {
			return r.convertError(err)
		}
		res, err := r.handlers.Manager.Connect(req.Context, &request)
		if err != nil {
			return r.convertError(err)
		}
		return res, nil
	}
	return r.notFound()
}
